<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Journal Detail - ReadWise</title>
    <link rel="stylesheet" href="css/style.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Application Insights SDK -->
    <script src="https://az416426.vo.msecnd.net/scripts/b/ai.2.min.js"></script>
    <script src="js/app-insights-init.js"></script>
</head>

<body>

    <nav class="navbar">
        <div class="nav-content">
            <a href="dashboard.html" class="nav-logo">ReadWise</a>
            <div class="nav-links">
                <a href="dashboard.html"><i class="fas fa-arrow-left"></i> Back</a>
                <a href="dashboard.html"><i class="fas fa-home"></i> Home</a>
                <a href="profile.html"><i class="fas fa-user"></i> My Profile</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Main Journal Card -->
        <div class="glass-card" style="padding: 40px; margin-bottom: 40px;">
            <div class="detail-header">
                <h1 id="j-title" class="detail-title">Loading...</h1>
                <div
                    style="color: var(--text-secondary); display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <span id="j-author"><i class="fas fa-user-circle"></i> ...</span>
                    <span>â€¢</span>
                    <span id="j-date">...</span>
                </div>
            </div>

            <div id="j-content" class="detail-content"></div>

            <!-- Media Grid -->
            <div class="media-section">
                <!-- Cover -->
                <div id="media-cover" class="media-item" style="display:none">
                    <p style="text-align:center; margin-bottom:10px; font-weight:600; color:var(--text-secondary)"><i
                            class="fas fa-image"></i> Cover</p>
                    <img id="img-cover" src="" alt="Cover" onclick="window.open(this.src)">
                </div>
                <!-- Notes -->
                <div id="media-notes" class="media-item" style="display:none">
                    <p style="text-align:center; margin-bottom:10px; font-weight:600; color:var(--text-secondary)"><i
                            class="fas fa-sticky-note"></i> Notes</p>
                    <img id="img-notes" src="" alt="Notes" onclick="window.open(this.src)">
                </div>
                <!-- Audio -->
                <div id="media-audio" class="media-item" style="display:none; grid-column: 1 / -1;">
                    <p style="text-align:center; margin-bottom:10px; font-weight:600; color:var(--text-secondary)"><i
                            class="fas fa-microphone"></i> Audio Note</p>
                    <audio id="audio-player" controls class="audio-player"></audio>
                </div>
            </div>

            <div id="author-actions"
                style="display: none; margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(0,0,0,0.1); text-align: right;">
                <button onclick="editJournal()" class="btn btn-secondary" style="width: auto; margin-right: 10px;">
                    <i class="fas fa-edit"></i> Edit
                </button>
                <button onclick="deleteJournal()" class="btn" style="width: auto; background: var(--danger-color);">
                    <i class="fas fa-trash-alt"></i> Delete
                </button>
            </div>
        </div>

        <!-- Reviews -->
        <div class="reviews-section">
            <h2 style="margin-bottom: 20px;"><i class="fas fa-comments" style="color: var(--primary-color);"></i>
                Reviews</h2>

            <form id="reviewForm" style="margin-bottom: 30px;">
                <div style="position: relative;">
                    <i class="fas fa-pen"
                        style="position: absolute; top: 15px; left: 15px; color: var(--text-secondary);"></i>
                    <textarea id="reviewText" rows="3" placeholder="Write a review..."
                        style="margin-bottom: 10px; padding-left: 40px;"></textarea>
                </div>
                <button type="submit" class="btn" style="width: auto; padding: 10px 24px;">
                    <i class="fas fa-paper-plane"></i> Post Review
                </button>
            </form>

            <div id="reviewsList">
                <!-- Reviews injected here -->
            </div>
        </div>


    </div>

    <script src="js/config.js"></script>
    <script>
        const user = CONFIG.requireAuth();
        const params = new URLSearchParams(window.location.search);
        const journalId = params.get('id');

        if (!journalId) {
            alert('No Journal ID specified');
            window.location.href = 'dashboard.html';
        }

        async function loadJournal() {
            try {
                // Our Logic App for 'get-journal-by-id' requires 'id' and 'userId' (partition key)
                // Since we might not know the author's userId from the URL list immediately if coming from a shared link,
                // we usually need it. However, the Logic App for 'get-journal-by-id' we built queries by Journal ID primarily.
                // Let's check Logic App 07 again. It uses Partition Key in the "Get Journal Document" action.
                // If partition key is wrong, it might fail. 
                // BUT, the 'Query Reviews' is a cross-partition query? 

                // CRITICAL FIX: The Logic App 07 expects `id` and `userId` in queries.
                // If we don't pass userId in URL from dashboard, we might have trouble getting the document directly by point read.
                // Let's assume dashboard passes it.

                const authorUserId = params.get('userId');

                const url = `${CONFIG.API.JOURNAL.GET_ONE}&id=${journalId}&userId=${authorUserId || ''}`;

                const res = await fetch(url);
                if (!res.ok) throw new Error('Failed to load journal');
                const data = await res.json();

                renderJournal(data);
            } catch (e) {
                console.error(e);
                document.querySelector('.container').innerHTML = '<p style="color:red">Failed to load journal details.</p>';
            }
        }

        function renderJournal(data) {
            // Data structure depends on Logic App response. 
            // It returns { ...journalFields, reviews: [...] }

            document.getElementById('j-title').textContent = data.title || 'Untitled';
            document.getElementById('j-author').innerHTML = `<i class="fas fa-user-circle"></i> ${data.username || 'Unknown'}`;
            document.getElementById('j-date').textContent = data.created_at ? new Date(data.created_at).toLocaleDateString() : '';
            document.getElementById('j-content').innerText = data.content || ''; // innerText preserves newlines

            // Media
            if (data.coverUrl) {
                document.getElementById('media-cover').style.display = 'block';
                document.getElementById('img-cover').src = data.coverUrl;
            }
            if (data.notesUrl) {
                document.getElementById('media-notes').style.display = 'block';
                document.getElementById('img-notes').src = data.notesUrl;
            }
            if (data.audioUrl) {
                document.getElementById('media-audio').style.display = 'block';
                document.getElementById('audio-player').src = data.audioUrl;
            }

            // Reviews
            const reviews = data.reviews || [];
            const reviewsList = document.getElementById('reviewsList');
            reviewsList.innerHTML = reviews.map(r => `
                <div class="review-item">
                    <div class="review-author">${r.username || 'User'} <span style="font-weight:400; color:grey; font-size:12px; float: right;">${r.created_at ? new Date(r.created_at).toLocaleDateString() : ''}</span></div>
                    <div class="review-text">${r.content}</div>
                </div>
            `).join('');

            // Controls
            if (String(user.id) === String(data.userId) || String(user.userId) === String(data.userId)) {
                document.getElementById('author-actions').style.display = 'block';
            }
        }

        // Initial Load
        loadJournal();

        // Delete Journal
        window.deleteJournal = async function () {
            if (!confirm('Are you sure? This cannot be undone.')) return;

            try {
                // Provide ID and Partition Key (userId)
                // Logic App 05 expects queries: id, userId
                const authorUserId = params.get('userId'); // We need this from URL param or loaded data

                const res = await fetch(`${CONFIG.API.JOURNAL.DELETE}&id=${journalId}&userId=${authorUserId}`, {
                    method: 'GET' // Or POST/DELETE depending on Logic App trigger. It's 'Request' trigger (likely POST/GET/Any). Logic App checks method?
                    // Logic App 05 trigger is generic. Let's use DELETE method if browser allows simple request, or POST if necessary.
                    // Actually, most Logic App HTTP triggers accept POST by default if not specified.
                    // Wait, Logic App 05 trigger definition says method "GET" or generic? 
                    // Let's try DELETE method.
                });

                // NOTE: Logic app trigger might be set to GET or POST. 
                // Assuming it works with method set in fetch options for trigger, 
                // OR if it's a GET trigger, we pass params in URL. 
                // Let's check 05 definition... It uses TriggerBody()?['id'] usually.
                // Wait, if 05 uses TriggerBody, it MUST be POST.
                // Let's check 05 provided code from memory...
                // 05-delete-journal.json uses inputs: { method: 'delete', path: ... queries: { partitionKey: @triggerBody()?['userId'] } }
                // So the Logic App ACTION uses DELETE. The TRIGGER usually accepts POST with body.

                // Re-checking 05 code... 05 uses `triggerBody()?['id']`. So we must send POST with body.
                const res2 = await fetch(CONFIG.API.JOURNAL.DELETE, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: journalId,
                        userId: params.get('userId') // Required for partition key
                    })
                });

                if (res2.ok) {
                    alert('Deleted successfully');
                    window.location.href = 'dashboard.html';
                } else {
                    alert('Failed to delete');
                }
            } catch (e) {
                console.error(e);
                alert('Error deleting journal');
            }
        };

        window.editJournal = function () {
            const authorUserId = params.get('userId');
            window.location.href = `create-journal.html?editId=${journalId}&userId=${authorUserId}`;
        };

        // Post Review
        document.getElementById('reviewForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = document.getElementById('reviewText').value;
            // Audio review upload omitted for simplicity, can emulate create-journal upload logic

            if (!text) return;

            const btn = e.target.querySelector('button');
            const originalText = btn.textContent;
            btn.textContent = 'Posting...';
            btn.disabled = true;

            try {
                const reviewData = {
                    journalId: journalId,
                    userId: user.id || user.userId,
                    username: user.username,
                    content: text,
                    audioUrl: "" // TODO: Implement audio upload for reviews if needed
                };

                const res = await fetch(CONFIG.API.REVIEW.CREATE, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(reviewData)
                });

                if (res.ok) {
                    location.reload(); // Reload to show new review
                } else {
                    alert('Failed to post review');
                }
            } catch (err) {
                console.error(err);
                alert('Error posting review');
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        });
    </script>
</body>

</html>