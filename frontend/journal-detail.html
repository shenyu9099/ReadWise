<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Journal Detail - ReadWise</title>
    <link rel="stylesheet" href="css/style.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Application Insights SDK -->
    <script src="https://az416426.vo.msecnd.net/scripts/b/ai.2.min.js"></script>
    <script src="js/app-insights-init.js"></script>
</head>

<body>

    <nav class="navbar">
        <div class="nav-content">
            <a href="dashboard.html" class="nav-logo">ReadWise</a>
            <div class="nav-links">
                <a href="dashboard.html"><i class="fas fa-arrow-left"></i> Back</a>
                <a href="dashboard.html"><i class="fas fa-home"></i> Home</a>
                <a href="profile.html"><i class="fas fa-user"></i> My Profile</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Main Journal Card -->
        <div class="glass-card" style="padding: 40px; margin-bottom: 40px;">
            <div class="detail-header">
                <h1 id="j-title" class="detail-title">Loading...</h1>
                <div
                    style="color: var(--text-secondary); display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <span id="j-author"><i class="fas fa-user-circle"></i> ...</span>
                    <span>‚Ä¢</span>
                    <span id="j-date">...</span>
                </div>
            </div>

            <div id="j-content" class="detail-content"></div>

            <!-- Media Grid -->
            <div class="media-section">
                <!-- Cover -->
                <div id="media-cover" class="media-item" style="display:none">
                    <p style="text-align:center; margin-bottom:10px; font-weight:600; color:var(--text-secondary)"><i
                            class="fas fa-image"></i> Cover</p>
                    <img id="img-cover" src="" alt="Cover" onclick="window.open(this.src)">
                </div>
                <!-- Notes (Multiple) -->
                <div id="media-notes" style="display:none">
                    <p style="text-align:center; margin-bottom:10px; font-weight:600; color:var(--text-secondary)"><i
                            class="fas fa-sticky-note"></i> Notes</p>
                    <div id="notes-gallery" style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
                    </div>
                </div>
                <!-- Audio (Multiple) -->
                <div id="media-audio" style="display:none; grid-column: 1 / -1;">
                    <p style="text-align:center; margin-bottom:10px; font-weight:600; color:var(--text-secondary)"><i
                            class="fas fa-microphone"></i> Audio Notes</p>
                    <div id="audio-gallery" style="display: flex; flex-direction: column; gap: 10px;"></div>
                    <!-- Transcribe Button with Language Selector -->
                    <div
                        style="text-align:center; margin-top:15px; display:flex; gap:10px; justify-content:center; align-items:center; flex-wrap:wrap;">
                        <select id="audio-language"
                            style="padding:8px 12px; border-radius:8px; background:#2a2a3e; color:#fff; border:1px solid #667eea;">
                            <option value="zh-CN">üá®üá≥ Chinese</option>
                            <option value="en-US">üá¨üáß English</option>
                            <option value="ja-JP">üáØüáµ Japanese</option>
                            <option value="ko-KR">üá∞üá∑ Korean</option>
                        </select>
                        <button id="transcribe-btn" onclick="transcribeAudio()" class="btn"
                            style="width:auto; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding:8px 20px;">
                            <i class="fas fa-file-alt"></i> Transcribe Audio
                        </button>
                    </div>
                    <div id="transcription-result"
                        style="display:none; margin-top:15px; padding:15px; background:rgba(0,0,0,0.3); border-radius:10px; white-space:pre-wrap;">
                    </div>
                </div>

                <!-- AI Features -->
                <div id="ai-features"
                    style="grid-column: 1 / -1; margin-top:20px; padding:15px; background: linear-gradient(135deg, rgba(102,126,234,0.1) 0%, rgba(118,75,162,0.1) 100%); border-radius:12px; border: 1px solid rgba(102,126,234,0.3);">
                    <p style="text-align:center; margin-bottom:15px; font-weight:600; color:#667eea;">
                        <i class="fas fa-robot"></i> AI Features
                    </p>
                    <div style="display:flex; gap:15px; justify-content:center; flex-wrap:wrap;">
                        <button onclick="translateContent('en')" class="btn"
                            style="width:auto; background: #10b981; padding:8px 15px;">
                            üá¨üáß Translate to English
                        </button>
                        <button onclick="translateContent('zh-Hans')" class="btn"
                            style="width:auto; background: #f59e0b; padding:8px 15px;">
                            üá®üá≥ Translate to Chinese
                        </button>
                        <button onclick="translateContent('ja')" class="btn"
                            style="width:auto; background: #ec4899; padding:8px 15px;">
                            üáØüáµ Translate to Japanese
                        </button>
                    </div>
                    <div id="translation-result"
                        style="display:none; margin-top:15px; padding:15px; background:rgba(0,0,0,0.3); border-radius:10px; white-space:pre-wrap;">
                    </div>
                </div>
            </div>

            <div id="author-actions"
                style="display: none; margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(0,0,0,0.1); text-align: right;">
                <button onclick="editJournal()" class="btn btn-secondary" style="width: auto; margin-right: 10px;">
                    <i class="fas fa-edit"></i> Edit
                </button>
                <button onclick="deleteJournal()" class="btn" style="width: auto; background: var(--danger-color);">
                    <i class="fas fa-trash-alt"></i> Delete
                </button>
            </div>
        </div>

        <!-- Reviews -->
        <div class="reviews-section">
            <h2 style="margin-bottom: 20px;"><i class="fas fa-comments" style="color: var(--primary-color);"></i>
                Reviews</h2>

            <form id="reviewForm" style="margin-bottom: 30px;">
                <div style="position: relative;">
                    <i class="fas fa-pen"
                        style="position: absolute; top: 15px; left: 15px; color: var(--text-secondary);"></i>
                    <textarea id="reviewText" rows="3" placeholder="Write a review..."
                        style="margin-bottom: 10px; padding-left: 40px;"></textarea>
                </div>
                <button type="submit" class="btn" style="width: auto; padding: 10px 24px;">
                    <i class="fas fa-paper-plane"></i> Post Review
                </button>
            </form>

            <div id="reviewsList">
                <!-- Reviews injected here -->
            </div>
        </div>


    </div>

    <script src="js/config.js"></script>
    <script>
        const user = CONFIG.requireAuth();
        const params = new URLSearchParams(window.location.search);
        const journalId = params.get('id');

        if (!journalId) {
            alert('No Journal ID specified');
            window.location.href = 'dashboard.html';
        }

        async function loadJournal() {
            try {
                // Our Logic App for 'get-journal-by-id' requires 'id' and 'userId' (partition key)
                // Since we might not know the author's userId from the URL list immediately if coming from a shared link,
                // we usually need it. However, the Logic App for 'get-journal-by-id' we built queries by Journal ID primarily.
                // Let's check Logic App 07 again. It uses Partition Key in the "Get Journal Document" action.
                // If partition key is wrong, it might fail. 
                // BUT, the 'Query Reviews' is a cross-partition query? 

                // CRITICAL FIX: The Logic App 07 expects `id` and `userId` in queries.
                // If we don't pass userId in URL from dashboard, we might have trouble getting the document directly by point read.
                // Let's assume dashboard passes it.

                const authorUserId = params.get('userId');

                const url = `${CONFIG.API.JOURNAL.GET_ONE}&id=${journalId}&userId=${authorUserId || ''}`;

                const res = await fetch(url);
                if (!res.ok) throw new Error('Failed to load journal');
                const data = await res.json();

                renderJournal(data);
            } catch (e) {
                console.error(e);
                document.querySelector('.container').innerHTML = '<p style="color:red">Failed to load journal details.</p>';
            }
        }

        function renderJournal(data) {
            // Data structure depends on Logic App response. 
            // It returns { ...journalFields, reviews: [...] }

            document.getElementById('j-title').textContent = data.title || 'Untitled';
            document.getElementById('j-author').innerHTML = `<i class="fas fa-user-circle"></i> ${data.username || 'Unknown'}`;
            document.getElementById('j-date').textContent = data.created_at ? new Date(data.created_at).toLocaleString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }) : '';
            document.getElementById('j-content').innerText = data.content || ''; // innerText preserves newlines

            // Media - Cover (single)
            if (data.coverUrl) {
                document.getElementById('media-cover').style.display = 'block';
                document.getElementById('img-cover').src = data.coverUrl;
            }

            // Media - Notes (multiple or single for backward compatibility)
            // Handle both array and JSON string formats
            let notesUrls = data.notesUrls || [];
            if (typeof notesUrls === 'string') {
                try { notesUrls = JSON.parse(notesUrls); } catch (e) { notesUrls = []; }
            }
            if (!Array.isArray(notesUrls)) notesUrls = [];
            if (notesUrls.length === 0 && data.notesUrl) notesUrls = [data.notesUrl];

            if (notesUrls.length > 0) {
                document.getElementById('media-notes').style.display = 'block';
                const notesGallery = document.getElementById('notes-gallery');
                notesGallery.innerHTML = notesUrls.map(url => `
                    <img src="${url}" alt="Note" onclick="window.open(this.src)" 
                         style="max-width: 200px; max-height: 150px; border-radius: 8px; cursor: pointer; border: 1px solid rgba(255,255,255,0.1);">
                `).join('');
            }

            // Media - Audio (multiple or single for backward compatibility)
            let audioUrls = data.audioUrls || [];
            if (typeof audioUrls === 'string') {
                try { audioUrls = JSON.parse(audioUrls); } catch (e) { audioUrls = []; }
            }
            if (!Array.isArray(audioUrls)) audioUrls = [];
            if (audioUrls.length === 0 && data.audioUrl) audioUrls = [data.audioUrl];

            if (audioUrls.length > 0) {
                document.getElementById('media-audio').style.display = 'block';
                const audioGallery = document.getElementById('audio-gallery');
                audioGallery.innerHTML = audioUrls.map((url, i) => `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="color: var(--primary-color); font-size: 12px;">Audio ${i + 1}</span>
                        <audio controls style="flex: 1;"><source src="${url}"></audio>
                    </div>
                `).join('');
            }

            // Reviews
            const reviews = data.reviews || [];
            const reviewsList = document.getElementById('reviewsList');
            reviewsList.innerHTML = reviews.map(r => `
                <div class="review-item">
                    <div class="review-author">${r.username || 'User'} <span style="font-weight:400; color:grey; font-size:12px; float: right;">${r.created_at ? new Date(r.created_at).toLocaleString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }) : ''}</span></div>
                    <div class="review-text">${r.content}</div>
                </div>
            `).join('');

            // Controls
            if (String(user.id) === String(data.userId) || String(user.userId) === String(data.userId)) {
                document.getElementById('author-actions').style.display = 'block';
            }
        }

        // Initial Load
        loadJournal();

        // Delete Journal
        window.deleteJournal = async function () {
            if (!confirm('Are you sure? This cannot be undone.')) return;

            try {
                // Provide ID and Partition Key (userId)
                // Logic App 05 expects queries: id, userId
                const authorUserId = params.get('userId'); // We need this from URL param or loaded data

                const res = await fetch(`${CONFIG.API.JOURNAL.DELETE}&id=${journalId}&userId=${authorUserId}`, {
                    method: 'GET' // Or POST/DELETE depending on Logic App trigger. It's 'Request' trigger (likely POST/GET/Any). Logic App checks method?
                    // Logic App 05 trigger is generic. Let's use DELETE method if browser allows simple request, or POST if necessary.
                    // Actually, most Logic App HTTP triggers accept POST by default if not specified.
                    // Wait, Logic App 05 trigger definition says method "GET" or generic? 
                    // Let's try DELETE method.
                });

                // NOTE: Logic app trigger might be set to GET or POST. 
                // Assuming it works with method set in fetch options for trigger, 
                // OR if it's a GET trigger, we pass params in URL. 
                // Let's check 05 definition... It uses TriggerBody()?['id'] usually.
                // Wait, if 05 uses TriggerBody, it MUST be POST.
                // Let's check 05 provided code from memory...
                // 05-delete-journal.json uses inputs: { method: 'delete', path: ... queries: { partitionKey: @triggerBody()?['userId'] } }
                // So the Logic App ACTION uses DELETE. The TRIGGER usually accepts POST with body.

                // Re-checking 05 code... 05 uses `triggerBody()?['id']`. So we must send POST with body.
                const res2 = await fetch(CONFIG.API.JOURNAL.DELETE, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: journalId,
                        userId: params.get('userId') // Required for partition key
                    })
                });

                if (res2.ok) {
                    alert('Deleted successfully');
                    window.location.href = 'dashboard.html';
                } else {
                    alert('Failed to delete');
                }
            } catch (e) {
                console.error(e);
                alert('Error deleting journal');
            }
        };

        window.editJournal = function () {
            const authorUserId = params.get('userId');
            window.location.href = `create-journal.html?editId=${journalId}&userId=${authorUserId}`;
        };

        // Post Review
        document.getElementById('reviewForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = document.getElementById('reviewText').value;
            // Audio review upload omitted for simplicity, can emulate create-journal upload logic

            if (!text) return;

            const btn = e.target.querySelector('button');
            const originalText = btn.textContent;
            btn.textContent = 'Posting...';
            btn.disabled = true;

            try {
                const reviewData = {
                    journalId: journalId,
                    userId: user.id || user.userId,
                    username: user.username,
                    content: text,
                    audioUrl: "", // TODO: Implement audio upload for reviews if needed
                    journalUserId: params.get('userId') // Author of the journal
                };

                const res = await fetch(CONFIG.API.REVIEW.CREATE, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(reviewData)
                });

                if (res.ok) {
                    location.reload(); // Reload to show new review
                } else {
                    alert('Failed to post review');
                }
            } catch (err) {
                console.error(err);
                alert('Error posting review');
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        });

        // Store current journal data for AI features
        let currentJournalData = null;

        // AI Feature: Transcribe Audio
        async function transcribeAudio() {
            const btn = document.getElementById('transcribe-btn');
            const resultDiv = document.getElementById('transcription-result');

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Transcribing...';
            resultDiv.style.display = 'none';

            try {
                // Get the first audio URL
                const audioGallery = document.getElementById('audio-gallery');
                const audioEl = audioGallery.querySelector('audio source');
                if (!audioEl) {
                    alert('No audio file found');
                    return;
                }

                const audioUrl = audioEl.src;
                console.log('Audio URL:', audioUrl);

                // Fetch audio file
                const audioResponse = await fetch(audioUrl);
                const audioBlob = await audioResponse.blob();
                console.log('Audio blob size:', audioBlob.size, 'type:', audioBlob.type);

                // Determine content type based on file extension
                let contentType = 'audio/wav';
                if (audioUrl.includes('.mp3')) {
                    contentType = 'audio/mpeg';
                } else if (audioUrl.includes('.ogg')) {
                    contentType = 'audio/ogg';
                }

                // Call Azure Speech-to-Text API with selected language
                const selectedLang = document.getElementById('audio-language').value;
                const response = await fetch(
                    `https://${CONFIG.AI.SPEECH.REGION}.stt.speech.microsoft.com/speech/recognition/conversation/cognitiveservices/v1?language=${selectedLang}&format=detailed`,
                    {
                        method: 'POST',
                        headers: {
                            'Ocp-Apim-Subscription-Key': CONFIG.AI.SPEECH.KEY,
                            'Content-Type': contentType,
                            'Accept': 'application/json'
                        },
                        body: audioBlob
                    }
                );

                console.log('Speech API response status:', response.status);
                const responseText = await response.text();
                console.log('Speech API response:', responseText);

                if (response.ok && responseText) {
                    const result = JSON.parse(responseText);
                    const displayText = result.DisplayText || result.NBest?.[0]?.Display || result.Text;
                    if (displayText) {
                        resultDiv.innerHTML = `<strong>üìù Transcription Result:</strong><br><br>${displayText}`;
                    } else {
                        resultDiv.innerHTML = `<span style="color:#f59e0b;">‚ö†Ô∏è No speech detected in audio. Status: ${result.RecognitionStatus || 'Unknown'}</span>`;
                    }
                    resultDiv.style.display = 'block';
                } else {
                    console.error('Transcription error:', responseText);
                    resultDiv.innerHTML = `<span style="color:#f87171;">Transcription failed (${response.status}): ${responseText || 'Unknown error'}</span>`;
                    resultDiv.style.display = 'block';
                }
            } catch (err) {
                console.error('Transcription error:', err);
                resultDiv.innerHTML = `<span style="color:#f87171;">Transcription error: ${err.message}</span>`;
                resultDiv.style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-file-alt"></i> Transcribe Audio';
            }
        }

        // AI Feature: Translate Content
        async function translateContent(targetLang) {
            const resultDiv = document.getElementById('translation-result');
            const content = document.getElementById('j-content').textContent;

            if (!content || content.trim() === '') {
                alert('No content to translate');
                return;
            }

            if (!CONFIG.AI.TRANSLATOR.KEY) {
                alert('Translation service not configured');
                return;
            }

            resultDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Translating...';
            resultDiv.style.display = 'block';

            try {
                const response = await fetch(
                    `${CONFIG.AI.TRANSLATOR.ENDPOINT}/translate?api-version=3.0&to=${targetLang}`,
                    {
                        method: 'POST',
                        headers: {
                            'Ocp-Apim-Subscription-Key': CONFIG.AI.TRANSLATOR.KEY,
                            'Ocp-Apim-Subscription-Region': CONFIG.AI.TRANSLATOR.REGION,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify([{ Text: content }])
                    }
                );

                if (response.ok) {
                    const result = await response.json();
                    const translatedText = result[0].translations[0].text;
                    const langNames = { 'en': 'English', 'zh-Hans': 'Chinese', 'ja': 'Japanese' };
                    resultDiv.innerHTML = `<strong>üåç ${langNames[targetLang] || targetLang} Translation:</strong><br><br>${translatedText}`;
                } else {
                    const error = await response.text();
                    console.error('Translation error:', error);
                    resultDiv.innerHTML = `<span style="color:#f87171;">Translation failed: ${error}</span>`;
                }
            } catch (err) {
                console.error('Translation error:', err);
                resultDiv.innerHTML = `<span style="color:#f87171;">Translation error: ${err.message}</span>`;
            }
        }
    </script>
</body>

</html>