<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Journal - ReadWise</title>
    <link rel="stylesheet" href="css/style.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Drop Zone Styles */
        .drop-zone {
            border: 2px dashed rgba(0, 243, 255, 0.3);
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(0, 243, 255, 0.02);
            margin-top: 10px;
        }

        .drop-zone:hover,
        .drop-zone.drag-over {
            border-color: var(--primary-color);
            background: rgba(0, 243, 255, 0.08);
        }

        .drop-zone-input {
            display: none;
        }

        .drop-zone-prompt {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            color: var(--text-secondary);
        }

        .drop-zone-prompt i {
            font-size: 32px;
            color: var(--primary-color);
        }

        .files-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
        }

        .file-item {
            background: rgba(0, 243, 255, 0.1);
            border: 1px solid rgba(0, 243, 255, 0.3);
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 12px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .file-item .remove-file {
            cursor: pointer;
            color: #ff0055;
        }

        .multi-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 10px 0;
        }

        .multi-preview img {
            max-width: 100px;
            max-height: 80px;
            border-radius: 8px;
            border: 1px solid rgba(0, 243, 255, 0.3);
        }

        .multi-preview audio {
            height: 30px;
        }
    </style>

    <!-- Application Insights SDK -->
    <script src="https://az416426.vo.msecnd.net/scripts/b/ai.2.min.js"></script>
    <script src="js/app-insights-init.js"></script>
</head>

<body>

    <nav class="navbar">
        <div class="nav-content">
            <a href="dashboard.html" class="nav-logo">ReadWise</a>
            <div class="nav-links">
                <a href="dashboard.html"><i class="fas fa-home"></i> Home</a>
                <a href="profile.html"><i class="fas fa-user"></i> My Profile</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="glass-card">
            <h1
                style="margin-bottom: 30px; border-bottom: 2px solid var(--primary-color); display: inline-block; padding-bottom: 10px;">
                New Journal</h1>

            <form id="createForm">
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" id="title" required placeholder="Enter journal title...">
                </div>

                <div class="form-group">
                    <label>Content</label>
                    <textarea id="content" rows="10" required placeholder="Write your thoughts..."></textarea>
                </div>

                <!-- Cover Image (Single) -->
                <div class="form-group">
                    <label><i class="fas fa-image" style="color: var(--primary-color);"></i> Cover Image (1
                        image)</label>
                    <div id="cover-preview" style="margin: 10px 0; display: none;">
                        <img id="cover-preview-img"
                            style="max-width: 150px; max-height: 100px; border-radius: 8px; border: 1px solid var(--primary-color);">
                    </div>
                    <div class="drop-zone" id="cover-drop-zone">
                        <input type="file" id="cover" accept="image/*" class="drop-zone-input">
                        <div class="drop-zone-prompt">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <span>Drag & drop or click to upload</span>
                        </div>
                        <div id="cover-files-list" class="files-list"></div>
                    </div>
                </div>

                <!-- Handwritten Notes (Multiple) -->
                <div class="form-group">
                    <label><i class="fas fa-sticky-note" style="color: #ff7675;"></i> Handwritten Notes (Multiple
                        images)</label>
                    <div id="notes-preview" class="multi-preview"></div>
                    <div class="drop-zone" id="notes-drop-zone">
                        <input type="file" id="notes" accept="image/*" multiple class="drop-zone-input">
                        <div class="drop-zone-prompt">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <span>Drag & drop or click to upload multiple</span>
                        </div>
                        <div id="notes-files-list" class="files-list"></div>
                    </div>
                </div>

                <!-- Audio Recording (Multiple) -->
                <div class="form-group">
                    <label><i class="fas fa-microphone" style="color: #fdcb6e;"></i> Audio Recordings (Multiple)</label>
                    <div id="audio-preview" class="multi-preview"></div>
                    <div class="drop-zone" id="audio-drop-zone">
                        <input type="file" id="audio" accept="audio/*" multiple class="drop-zone-input">
                        <div class="drop-zone-prompt">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <span>Drag & drop or click to upload multiple</span>
                        </div>
                        <div id="audio-files-list" class="files-list"></div>
                    </div>
                </div>
        </div>

        <button type="submit" class="btn">
            <i class="fas fa-paper-plane"></i> Publish Journal
        </button>
        </form>
    </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/telemetry.js"></script>
    <script>
        const user = CONFIG.requireAuth();
        const params = new URLSearchParams(window.location.search);
        const editId = params.get('editId');
        const editUserId = params.get('userId');
        const isEditMode = !!editId;

        // Store original media URLs for edit mode
        let originalCoverUrl = '';
        let originalNotesUrls = [];  // Array format
        let originalAudioUrls = [];  // Array format

        // Update page title and button if editing
        if (isEditMode) {
            document.querySelector('h1').textContent = 'Edit Journal';
            document.querySelector('title').textContent = 'Edit Journal - ReadWise';
            document.querySelector('button[type="submit"]').innerHTML = '<i class="fas fa-save"></i> Update Journal';
        }

        // Load existing data if editing
        async function loadJournalForEdit() {
            if (!isEditMode) return;

            try {
                const url = `${CONFIG.API.JOURNAL.GET_ONE}&id=${editId}&userId=${editUserId}`;
                const res = await fetch(url);
                if (!res.ok) throw new Error('Failed to load journal');
                const data = await res.json();

                document.getElementById('title').value = data.title || '';
                document.getElementById('content').value = data.content || '';

                // Store original URLs (support both array and single formats)
                // Parse JSON strings if needed
                originalCoverUrl = data.coverUrl || '';

                let tempNotesUrls = data.notesUrls || [];
                if (typeof tempNotesUrls === 'string') {
                    try { tempNotesUrls = JSON.parse(tempNotesUrls); } catch (e) { tempNotesUrls = []; }
                }
                if (!Array.isArray(tempNotesUrls)) tempNotesUrls = [];
                if (tempNotesUrls.length === 0 && data.notesUrl) tempNotesUrls = [data.notesUrl];
                originalNotesUrls = tempNotesUrls;

                let tempAudioUrls = data.audioUrls || [];
                if (typeof tempAudioUrls === 'string') {
                    try { tempAudioUrls = JSON.parse(tempAudioUrls); } catch (e) { tempAudioUrls = []; }
                }
                if (!Array.isArray(tempAudioUrls)) tempAudioUrls = [];
                if (tempAudioUrls.length === 0 && data.audioUrl) tempAudioUrls = [data.audioUrl];
                originalAudioUrls = tempAudioUrls;

                // Show existing media previews
                if (originalCoverUrl) {
                    document.getElementById('cover-preview').style.display = 'block';
                    document.getElementById('cover-preview-img').src = originalCoverUrl;
                    document.getElementById('cover-files-list').innerHTML = '<div class="file-item"><span style="color: #4ade80;">âœ“ Current image loaded</span></div>';
                }

                // Render existing files with delete buttons
                renderExistingUrls();
            } catch (e) {
                console.error(e);
                alert('Failed to load journal for editing');
            }
        }
        loadJournalForEdit();

        // Render existing URLs with delete buttons
        function renderExistingUrls() {
            // Notes section
            const notesList = document.getElementById('notes-files-list');
            const notesPreview = document.getElementById('notes-preview');

            let notesHtml = '';
            originalNotesUrls.forEach((url, i) => {
                const filename = url.split('/').pop().substring(14) || 'image'; // Remove timestamp
                notesHtml += `<div class="file-item" style="background: rgba(74,222,128,0.15);">
                    <span title="${url}">ðŸ“· ${filename.length > 25 ? filename.substring(0, 22) + '...' : filename}</span>
                    <i class="fas fa-times remove-file" onclick="removeExistingUrl('notes', ${i})" style="cursor:pointer; color:#f87171;"></i>
                </div>`;
            });
            selectedNotesFiles.forEach((f, i) => {
                notesHtml += `<div class="file-item">
                    <span>ðŸ“ ${f.name.length > 25 ? f.name.substring(0, 22) + '...' : f.name}</span>
                    <i class="fas fa-times remove-file" onclick="removeFile('notes', ${i})" style="cursor:pointer; color:#f87171;"></i>
                </div>`;
            });
            notesList.innerHTML = notesHtml || '<div style="color:#666; font-size:12px;">Drop files or click to upload</div>';

            // Notes preview images
            notesPreview.innerHTML = originalNotesUrls.map(url =>
                `<img src="${url}" style="max-width:80px; max-height:60px; border-radius:6px; border:2px solid #4ade80;">`
            ).join('');

            // Audio section
            const audioList = document.getElementById('audio-files-list');
            const audioPreview = document.getElementById('audio-preview');

            let audioHtml = '';
            originalAudioUrls.forEach((url, i) => {
                const filename = url.split('/').pop().substring(14) || 'audio';
                audioHtml += `<div class="file-item" style="background: rgba(74,222,128,0.15);">
                    <span title="${url}">ðŸŽµ ${filename.length > 25 ? filename.substring(0, 22) + '...' : filename}</span>
                    <i class="fas fa-times remove-file" onclick="removeExistingUrl('audio', ${i})" style="cursor:pointer; color:#f87171;"></i>
                </div>`;
            });
            selectedAudioFiles.forEach((f, i) => {
                audioHtml += `<div class="file-item">
                    <span>ðŸ“ ${f.name.length > 25 ? f.name.substring(0, 22) + '...' : f.name}</span>
                    <i class="fas fa-times remove-file" onclick="removeFile('audio', ${i})" style="cursor:pointer; color:#f87171;"></i>
                </div>`;
            });
            audioList.innerHTML = audioHtml || '<div style="color:#666; font-size:12px;">Drop files or click to upload</div>';

            // Audio preview players
            audioPreview.innerHTML = originalAudioUrls.map(url =>
                `<audio controls style="height:28px; max-width:150px;"><source src="${url}"></audio>`
            ).join('');
        }

        // Remove existing URL (already uploaded file)
        function removeExistingUrl(type, index) {
            if (type === 'notes') {
                originalNotesUrls.splice(index, 1);
            } else if (type === 'audio') {
                originalAudioUrls.splice(index, 1);
            }
            renderExistingUrls();
        }

        // Helper to convert file to base64
        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = error => reject(error);
        });

        // Helper to upload file via Logic App (MediaShare Pro style)
        async function uploadFile(file, containerName) {
            if (!file) return null;

            try {
                const fileContent = await toBase64(file);
                const fileName = Date.now() + '-' + file.name.replace(/[^a-zA-Z0-9.-]/g, '_');

                const res = await fetch(CONFIG.API.UPLOAD, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        containerName: containerName,
                        fileName: fileName,
                        fileContent: fileContent
                    })
                });

                if (!res.ok) throw new Error('Upload failed');
                const data = await res.json();

                // Track successful file upload
                if (window.Telemetry) {
                    window.Telemetry.trackEvent('FileUpload', {
                        containerName: containerName,
                        fileName: fileName,
                        fileSize: file ? file.size : 0,
                        fileType: file ? file.type : 'unknown'
                    }, {
                        fileSize: file ? file.size : 0,
                        uploadDuration: Date.now() - (window.uploadStartTime || Date.now())
                    });
                }

                return data.publicUrl;
            } catch (e) {
                console.error('Upload failed:', e);

                // Track upload failure
                if (window.Telemetry) {
                    window.Telemetry.trackException(e, 'browser', {
                        containerName: containerName,
                        fileName: file ? file.name : 'unknown',
                        errorMessage: e.message
                    });
                }

                alert('File upload failed: ' + e.message);
                return null;
            }
        }

        // Helper to update file label text
        function updateFileName(input, labelId) {
            const fileName = input.files && input.files.length > 0 ? input.files[0].name : "No file chosen";
            document.getElementById(labelId).textContent = fileName;
        }

        // Store selected files (for multi-file support)
        let selectedNotesFiles = [];
        let selectedAudioFiles = [];

        // Initialize Drag & Drop zones
        function initDropZones() {
            const dropZones = document.querySelectorAll('.drop-zone');

            dropZones.forEach(zone => {
                const input = zone.querySelector('.drop-zone-input');
                const filesListId = zone.id.replace('-drop-zone', '-files-list');
                const filesList = document.getElementById(filesListId);

                // Click to open file dialog
                zone.addEventListener('click', () => input.click());

                // Drag events
                zone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    zone.classList.add('drag-over');
                });

                zone.addEventListener('dragleave', () => {
                    zone.classList.remove('drag-over');
                });

                zone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    zone.classList.remove('drag-over');

                    const files = e.dataTransfer.files;
                    handleFileSelection(zone.id, files);
                });

                // File input change
                input.addEventListener('change', () => {
                    handleFileSelection(zone.id, input.files);
                });
            });
        }

        function handleFileSelection(zoneId, files) {
            const filesArray = Array.from(files);
            const filesListId = zoneId.replace('-drop-zone', '-files-list');
            const filesList = document.getElementById(filesListId);

            if (zoneId === 'cover-drop-zone') {
                // Single file for cover
                if (files.length > 0) {
                    filesList.innerHTML = `<div class="file-item">${files[0].name}</div>`;
                    // Show preview
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        document.getElementById('cover-preview').style.display = 'block';
                        document.getElementById('cover-preview-img').src = e.target.result;
                    };
                    reader.readAsDataURL(files[0]);
                }
            } else if (zoneId === 'notes-drop-zone') {
                selectedNotesFiles = [...selectedNotesFiles, ...filesArray];
                isEditMode ? renderExistingUrls() : renderFilesList('notes-files-list', selectedNotesFiles, 'notes');
            } else if (zoneId === 'audio-drop-zone') {
                selectedAudioFiles = [...selectedAudioFiles, ...filesArray];
                isEditMode ? renderExistingUrls() : renderFilesList('audio-files-list', selectedAudioFiles, 'audio');
            }
        }

        function renderFilesList(listId, files, type) {
            const list = document.getElementById(listId);
            list.innerHTML = files.map((f, i) => `
                <div class="file-item">
                    <span>${f.name}</span>
                    <i class="fas fa-times remove-file" onclick="removeFile('${type}', ${i})"></i>
                </div>
            `).join('');
        }

        function removeFile(type, index) {
            if (type === 'notes') {
                selectedNotesFiles.splice(index, 1);
            } else if (type === 'audio') {
                selectedAudioFiles.splice(index, 1);
            }
            // In edit mode, render both existing and new files together
            if (isEditMode) {
                renderExistingUrls();
            } else {
                renderFilesList(type + '-files-list', type === 'notes' ? selectedNotesFiles : selectedAudioFiles, type);
            }
        }

        // Initialize drop zones
        initDropZones();

        // Upload multiple files and return array of URLs
        async function uploadMultipleFiles(files, containerName) {
            if (!files || files.length === 0) return [];
            const urls = await Promise.all(files.map(f => uploadFile(f, containerName)));
            return urls.filter(url => url !== null);
        }

        document.getElementById('createForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.querySelector('button[type="submit"]');
            btn.disabled = true;
            btn.textContent = isEditMode ? 'Updating...' : 'Publishing...';

            try {
                const title = document.getElementById('title').value;
                const content = document.getElementById('content').value;

                const coverFile = document.getElementById('cover').files[0];

                // Track upload start time
                window.uploadStartTime = Date.now();

                // Upload cover (single)
                const coverUrl = await uploadFile(coverFile, 'covers');

                // Upload notes (multiple) - these are NEW files only
                const newNotesUrls = await uploadMultipleFiles(selectedNotesFiles, 'notes');

                // Upload audio (multiple) - these are NEW files only
                const newAudioUrls = await uploadMultipleFiles(selectedAudioFiles, 'audio');

                // Keep original cover URL if no new file uploaded
                const finalCoverUrl = coverUrl || (isEditMode ? originalCoverUrl : '');

                // MERGE existing URLs with newly uploaded URLs
                const finalNotesUrls = [...originalNotesUrls, ...newNotesUrls];
                const finalAudioUrls = [...originalAudioUrls, ...newAudioUrls];

                const journalData = {
                    title,
                    content,
                    userId: String(user.id || user.userId),
                    username: user.username,
                    coverUrl: finalCoverUrl,
                    notesUrls: finalNotesUrls,
                    audioUrls: finalAudioUrls
                };

                console.log('Submitting:', journalData);

                let res;
                if (isEditMode) {
                    // Update existing journal
                    journalData.id = editId;
                    res = await fetch(CONFIG.API.JOURNAL.UPDATE, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(journalData)
                    });
                } else {
                    // Create new journal
                    res = await fetch(CONFIG.API.JOURNAL.CREATE, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(journalData)
                    });
                }

                if (res.ok) {
                    // Track successful journal creation/update
                    if (window.Telemetry) {
                        window.Telemetry.trackEvent(isEditMode ? 'JournalUpdated' : 'JournalCreated', {
                            journalId: isEditMode ? editId : 'new',
                            userId: user.id || user.userId,
                            hasCover: !!finalCoverUrl,
                            hasNotes: finalNotesUrls.length > 0,
                            hasAudio: finalAudioUrls.length > 0
                        });
                    }

                    alert(isEditMode ? 'Journal updated successfully!' : 'Journal published successfully!');
                    window.location.href = isEditMode ? `journal-detail.html?id=${editId}&userId=${editUserId}` : 'dashboard.html';
                } else {
                    throw new Error(isEditMode ? 'Failed to update journal' : 'Failed to create journal');
                }
            } catch (error) {
                console.error(error);
                alert('Error: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = isEditMode ? 'Update Journal' : 'Publish Journal';
            }
        });
    </script>
</body>

</html>